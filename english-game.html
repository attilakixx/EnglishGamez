<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AtiToolz â€¢ English Picture Game</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ‡¬ðŸ‡§%3C/text%3E%3C/svg%3E" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Page-specific overrides to make the game full and simple */
      main { max-width: none; width: 100vw; padding: clamp(0.5rem, 2vh, 2rem); padding-block-end: 4rem; }
      .game {
        display: grid;
        grid-template-rows: 1fr auto;
        gap: clamp(0.75rem, 2vh, 1.25rem);
        place-items: center;
        min-height: 85vh;
      }
      .picture-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: clamp(0.75rem, 2vw, 1.25rem);
        width: 100%;
      }
      #picture {
        max-width: min(72vw, 900px);
        max-height: 70vh;
        object-fit: contain;
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px color-mix(in oklab, var(--fg) 15%, transparent);
        cursor: pointer;
        user-select: none;
        -webkit-user-drag: none;
      }
      .judgeBtn {
        font-size: clamp(1rem, 2.8vw, 1.4rem);
        padding: clamp(0.75rem, 2.4vh, 1.1rem) clamp(0.9rem, 3vw, 1.3rem);
        border-radius: 0.75rem;
        border: none;
        min-width: 64px;
        cursor: pointer;
        box-shadow: 0 6px 18px color-mix(in oklab, var(--fg) 30%, transparent);
        color: #ffffff;
        font-weight: 700;
      }
      #correctBtn {
        background: #16a34a;
      }
      #incorrectBtn {
        background: #dc2626;
      }
      .judgeBtn:active {
        transform: translateY(1px);
      }
      #nextBtn {
        font-size: clamp(1.25rem, 3.5vw, 2rem);
        padding: clamp(0.75rem, 2.8vh, 1.25rem) clamp(1.5rem, 6vw, 2.5rem);
        border: none;
        border-radius: 0.75rem;
        background: color-mix(in oklab, var(--accent) 70%, transparent);
        color: white;
        box-shadow: 0 6px 18px color-mix(in oklab, var(--accent) 40%, transparent);
        cursor: pointer;
        width: min(90vw, 420px);
      }
      #nextBtn:active { transform: translateY(1px); }
      .topbar { text-align: center; margin-block-end: 0.5rem; color: var(--muted); }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    </style>
    <style>
      #backBtn {
        position: fixed;
        inset-block-start: 0.75rem;
        inset-inline-start: 0.75rem;
        z-index: 1000;
        text-decoration: none;
        font-weight: 700;
        font-size: clamp(1rem, 2.5vw, 1.25rem);
        padding: 0.5rem 0.9rem;
        border-radius: 0.6rem;
        background: color-mix(in oklab, var(--fg) 12%, transparent);
        color: var(--fg);
        box-shadow: 0 4px 14px color-mix(in oklab, var(--fg) 18%, transparent);
      }
    </style>
  </head>
  <body>
    <a id="backBtn" href="index.html" aria-label="Back to home">â¬… BACK</a>
    <main>
      <h1>English Picture Game</h1>
      <p class="topbar">
        Tap the picture to hear its name. Tap âœ“ if you knew it, âœ— if you didn&apos;t.
      </p>
      <section class="game" aria-live="polite">
        <div class="picture-row">
          <button id="incorrectBtn" class="judgeBtn" type="button" aria-label="I did not know this word">
            âœ—
          </button>
          <img id="picture" alt="Picture for the word" />
          <button id="correctBtn" class="judgeBtn" type="button" aria-label="I knew this word">
            âœ“
          </button>
        </div>
        <button id="nextBtn" type="button" aria-label="Show next picture">Next â–¶</button>
        <span id="word" class="sr-only" aria-hidden="true"></span>
      </section>
    </main>
    <script>
      // Files come from an auto-generated manifest; falls back to this default list.
      let files = [];
      const DEFAULT_FILES = [
        'ball.jpg',
        'big small.jpeg',
        'bike.jpeg',
        'book.jpeg',
        'boy.jpeg',
        'brother.png',
        'car.jpeg',
        'cat.jpeg',
        'chair.jpeg',
        'cow.jpeg',
        'crayon.jpeg',
        'dad.png',
        'dog.jpeg',
        'doll.jpeg',
        'duck.jpeg',
        'girl.jpeg',
        'goat.jpeg',
        'guitar.jpeg',
        'hen.jpeg',
        'horse.jpeg',
        'mom.jpg',
        'notebook.jpeg',
        'old new.jpeg',
        'pen.jpeg',
        'pencil case.jpg',
        'pencil.png',
        'rabbit.jpeg',
        'rooster.jpeg',
        'rubber.jpeg',
        'ruler.jpeg',
        'scooter.jpeg',
        'sheep.jpeg',
        'sister.jpg',
        'tracktor.jpeg',
      ];

      const basePath = 'english_game/';
      const imgEl = document.getElementById('picture');
      const nextBtn = document.getElementById('nextBtn');
      const wordEl = document.getElementById('word');
      const correctBtn = document.getElementById('correctBtn');
      const incorrectBtn = document.getElementById('incorrectBtn');

      let remaining = [];
      let currentFile = null;
      let finished = false;

      function fileToLabel(file) {
        const base = file.replace(/^.*[\\\/]/, '').replace(/\.[^/.]+$/, '');
        return base.replace(/[-_]+/g, ' ').trim();
      }

      function pickNextFile() {
        if (!remaining.length) return null;
        if (remaining.length === 1) return remaining[0];
        let candidate = null;
        let tries = 0;
        do {
          const i = Math.floor(Math.random() * remaining.length);
          candidate = remaining[i];
          tries += 1;
        } while (candidate === currentFile && tries < 6 && remaining.length > 1);
        return candidate;
      }

      function showFile(file) {
        if (!file) return;
        currentFile = file;
        const label = fileToLabel(file);
        wordEl.textContent = label;
        const encoded = encodeURIComponent(file);
        const url = basePath + encoded;
        imgEl.src = url;
        imgEl.alt = label;
      }

      function next() {
        if (finished || !remaining.length) return;
        const file = pickNextFile();
        if (!file) {
          endGame();
          return;
        }
        showFile(file);
      }

      function endGame() {
        finished = true;
        currentFile = null;
        imgEl.src = '';
        imgEl.alt = 'All pictures completed';
        wordEl.textContent = '';
        nextBtn.disabled = true;
        correctBtn.disabled = true;
        incorrectBtn.disabled = true;
        nextBtn.textContent = 'Done âœ”';
      }

      function markCorrect() {
        if (finished || !currentFile) return;
        const idx = remaining.indexOf(currentFile);
        if (idx !== -1) remaining.splice(idx, 1);
        if (!remaining.length) {
          endGame();
          return;
        }
        next();
      }

      function markIncorrect() {
        if (finished || !currentFile) return;
        next();
      }

      // Speech synthesis utils (click image to speak)
      function getPreferredVoice() {
        try {
          const voices = speechSynthesis.getVoices();
          if (!voices || !voices.length) return null;
          const code = (localStorage.getItem('egAccent') || '').toLowerCase();
          if (code) {
            let v = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(code));
            if (!v) {
              const alias = {
                'en-gb': ['uk', 'british'],
                'en-us': ['us', 'american'],
                'en-au': ['au', 'australian'],
                'en-in': ['indian', 'india'],
                'en-ie': ['irish'],
                'en-ca': ['canadian', 'canada'],
                'en-za': ['south african', 'za'],
                'en-nz': ['new zealand', 'nz', 'kiwi'],
              }[code];
              if (alias) {
                v = voices.find(vv => alias.some(a => (vv.name || '').toLowerCase().includes(a)));
              }
            }
            if (v) return v;
          }
          return voices.find(v => v.lang && v.lang.toLowerCase().startsWith('en')) || null;
        } catch { return null; }
      }

      function speak(text) {
        try {
          if (!('speechSynthesis' in window)) return;
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(text);
          const preferred = getPreferredVoice();
          const code = (localStorage.getItem('egAccent') || '').toLowerCase();
          if (preferred) utter.voice = preferred; else if (code) utter.lang = code;
          utter.rate = 0.95;
          utter.pitch = 1.0;
          speechSynthesis.speak(utter);
        } catch (_) { /* ignore */ }
      }

      imgEl.addEventListener('click', () => {
        if (!wordEl.textContent) return;
        speak(wordEl.textContent);
      });
      nextBtn.addEventListener('click', next);
      correctBtn.addEventListener('click', markCorrect);
      incorrectBtn.addEventListener('click', markIncorrect);

      // Keyboard: Space -> speak, Enter -> next
      window.addEventListener('keydown', (e) => {
        const key = e.code || e.key;
        if (key === 'Enter' || e.key === 'Enter') {
          e.preventDefault();
          markIncorrect();
          return;
        }
        const isSpace = key === 'Space' || e.key === ' ' || e.key === 'Spacebar';
        if (isSpace) {
          e.preventDefault();
          if (!wordEl.textContent) return;
          speak(wordEl.textContent);
        }
      });

      // Load manifest.json if present, otherwise fall back to DEFAULT_FILES
      async function loadFiles() {
        try {
          const res = await fetch(basePath + 'manifest.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('No manifest');
          const arr = await res.json();
          if (!Array.isArray(arr) || !arr.length) throw new Error('Empty manifest');
          return arr;
        } catch {
          return DEFAULT_FILES.slice();
        }
      }

      (async () => {
        files = await loadFiles();
        remaining = files.slice();
        next();
      })();
    </script>
  </body>
  </html>
