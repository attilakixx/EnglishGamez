<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AtiToolz â€¢ Memory Game</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ§ %3C/text%3E%3C/svg%3E"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      main {
        max-width: none;
        width: 100vw;
        padding: clamp(0.5rem, 2vh, 2rem);
        padding-block-end: 4rem;
      }
      .layout {
        display: grid;
        gap: clamp(0.75rem, 2vh, 1.25rem);
        min-height: 85vh;
      }
      .topbar {
        text-align: center;
        margin-block-end: 0.5rem;
        color: var(--muted);
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: center;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.9rem;
        background: color-mix(in oklab, var(--fg) 5%, transparent);
      }
      .controls label {
        font-weight: 600;
      }
      #pairRange {
        width: min(60vw, 260px);
      }
      #startBtn {
        font-size: clamp(1rem, 2.8vw, 1.3rem);
        padding: 0.6rem 1.3rem;
        border-radius: 0.8rem;
        border: none;
        background: color-mix(in oklab, var(--accent) 70%, transparent);
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 14px color-mix(in oklab, var(--accent) 40%, transparent);
      }
      #startBtn:active {
        transform: translateY(1px);
      }
      #status {
        text-align: center;
        color: var(--muted);
        min-height: 1.5em;
      }
      .board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: clamp(0.5rem, 1.5vw, 0.9rem);
        margin-top: 0.5rem;
      }
      .card {
        position: relative;
        width: 100%;
        aspect-ratio: 3 / 4;
        border-radius: 0.9rem;
        border: 4px solid color-mix(in oklab, var(--fg) 20%, transparent);
        background: color-mix(in oklab, var(--fg) 8%, transparent);
        box-shadow: 0 8px 20px color-mix(in oklab, var(--fg) 18%, transparent);
        overflow: hidden;
        cursor: pointer;
        padding: 0;
        display: grid;
        place-items: center;
        transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.2s ease;
      }
      .card:active {
        transform: translateY(1px);
        box-shadow: 0 4px 12px color-mix(in oklab, var(--fg) 18%, transparent);
      }
      .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
      }
      .card-cover {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 800;
        color: var(--fg);
        background: color-mix(in oklab, var(--fg) 10%, transparent);
      }
      .card-img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: var(--bg);
        display: none;
      }
      .card.is-flipped .card-cover {
        display: none;
      }
      .card.is-flipped .card-img {
        display: block;
      }
      .card.matched {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      #backBtn {
        position: fixed;
        inset-block-start: 0.75rem;
        inset-inline-start: 0.75rem;
        z-index: 1000;
        text-decoration: none;
        font-weight: 700;
        font-size: clamp(1rem, 2.5vw, 1.25rem);
        padding: 0.5rem 0.9rem;
        border-radius: 0.6rem;
        background: color-mix(in oklab, var(--fg) 12%, transparent);
        color: var(--fg);
        box-shadow: 0 4px 14px color-mix(in oklab, var(--fg) 18%, transparent);
      }
    </style>
  </head>
  <body>
    <a id="backBtn" href="index.html" aria-label="Back to home">â¬… BACK</a>
    <main>
      <h1>Memory Game</h1>
      <p class="topbar">
        Choose how many pairs, then flip the cards to find all matches. Tap a card to hear the word.
      </p>
      <section class="layout" aria-live="polite">
        <div class="controls">
          <label for="pairRange">
            Pairs:
            <span id="pairCountLabel">8</span>
          </label>
          <input
            id="pairRange"
            type="range"
            min="4"
            max="12"
            step="1"
            value="8"
            aria-valuemin="4"
            aria-valuemax="12"
            aria-valuenow="8"
            aria-label="Number of pairs between 4 and 12"
          />
          <button id="startBtn" type="button">Start game</button>
        </div>
        <div id="status" aria-live="polite">Pick how many pairs and press Start.</div>
        <div id="board" class="board" aria-label="Memory cards"></div>
        <span id="currentWord" class="sr-only" aria-hidden="true"></span>
      </section>
    </main>
    <script>
      const basePath = 'english_game/';
      let files = [];

      const DEFAULT_FILES = [
        'ball.jpg',
        'big small.jpeg',
        'bike.jpeg',
        'book.jpeg',
        'boy.jpeg',
        'brother.png',
        'car.jpeg',
        'cat.jpeg',
        'chair.jpeg',
        'cow.jpeg',
        'crayon.jpeg',
        'dad.png',
        'dog.jpeg',
        'doll.jpeg',
        'duck.jpeg',
        'girl.jpeg',
        'goat.jpeg',
        'guitar.jpeg',
        'hen.jpeg',
        'horse.jpeg',
        'mom.jpg',
        'notebook.jpeg',
        'old new.jpeg',
        'pen.jpeg',
        'pencil case.jpg',
        'pencil.png',
        'rabbit.jpeg',
        'rooster.jpeg',
        'rubber.jpeg',
        'ruler.jpeg',
        'scooter.jpeg',
        'sheep.jpeg',
        'sister.jpg',
        'tracktor.jpeg',
      ];

      const boardEl = document.getElementById('board');
      const statusEl = document.getElementById('status');
      const pairRange = document.getElementById('pairRange');
      const pairCountLabel = document.getElementById('pairCountLabel');
      const startBtn = document.getElementById('startBtn');
      const currentWordEl = document.getElementById('currentWord');

      let deck = [];
      let flipped = [];
      let matchesFound = 0;
      let busy = false;

      function fileToLabel(file) {
        const base = file.replace(/^.*[\\\/]/, '').replace(/\.[^/.]+$/, '');
        return base.replace(/[-_]+/g, ' ').trim();
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getPreferredVoice() {
        try {
          const voices = speechSynthesis.getVoices();
          if (!voices || !voices.length) return null;
          const code = (localStorage.getItem('egAccent') || '').toLowerCase();
          if (code) {
            let v = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(code));
            if (!v) {
              const alias = {
                'en-gb': ['uk', 'british'],
                'en-us': ['us', 'american'],
                'en-au': ['au', 'australian'],
                'en-in': ['indian', 'india'],
                'en-ie': ['irish'],
                'en-ca': ['canadian', 'canada'],
                'en-za': ['south african', 'za'],
                'en-nz': ['new zealand', 'nz', 'kiwi'],
              }[code];
              if (alias) {
                v = voices.find(vv => alias.some(a => (vv.name || '').toLowerCase().includes(a)));
              }
            }
            if (v) return v;
          }
          return voices.find(v => v.lang && v.lang.toLowerCase().startsWith('en')) || null;
        } catch {
          return null;
        }
      }

      function speak(text) {
        try {
          if (!('speechSynthesis' in window)) return;
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(text);
          const preferred = getPreferredVoice();
          const code = (localStorage.getItem('egAccent') || '').toLowerCase();
          if (preferred) utter.voice = preferred;
          else if (code) utter.lang = code;
          utter.rate = 0.95;
          utter.pitch = 1.0;
          speechSynthesis.speak(utter);
        } catch (_) {
          /* ignore */
        }
      }

      function updatePairLabel() {
        const count = Number(pairRange.value) || 8;
        pairCountLabel.textContent = String(count);
        pairRange.setAttribute('aria-valuenow', String(count));
      }

      pairRange.addEventListener('input', updatePairLabel);

      function buildDeck(pairCount) {
        const maxPairs = Math.min(pairCount, Math.floor(files.length));
        const usePairs = Math.max(1, Math.min(maxPairs, 12));
        const pool = files.slice();
        shuffle(pool);
        const chosen = pool.slice(0, usePairs);
        const cards = [];
        let idCounter = 0;
        chosen.forEach(file => {
          const label = fileToLabel(file);
          cards.push({ id: idCounter++, file, label });
          cards.push({ id: idCounter++, file, label });
        });
        return shuffle(cards);
      }

      function clearBoard() {
        while (boardEl.firstChild) boardEl.removeChild(boardEl.firstChild);
      }

      function renderBoard() {
        clearBoard();
        deck.forEach((card, index) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'card';
          btn.dataset.index = String(index);
          btn.setAttribute('aria-label', 'Hidden card');

          const inner = document.createElement('div');
          inner.className = 'card-inner';

          const cover = document.createElement('div');
          cover.className = 'card-cover';
          cover.textContent = 'ðŸ§ ';

          const img = document.createElement('img');
          img.className = 'card-img';
          img.alt = card.label;
          img.src = basePath + encodeURIComponent(card.file);

          inner.appendChild(cover);
          inner.appendChild(img);
          btn.appendChild(inner);

          btn.addEventListener('click', () => handleCardClick(index, btn, img));
          boardEl.appendChild(btn);
        });
      }

      function handleCardClick(index, btn, imgEl) {
        if (busy) return;
        const card = deck[index];
        if (!card || card.matched) return;
        if (flipped.some(f => f.index === index)) return;

        btn.classList.add('is-flipped');
        btn.setAttribute('aria-label', card.label);
        const label = card.label;
        currentWordEl.textContent = label;
        speak(label);

        flipped.push({ index, btn });

        if (flipped.length === 2) {
          checkMatch();
        }
      }

      function checkMatch() {
        if (flipped.length !== 2) return;
        const [a, b] = flipped;
        const cardA = deck[a.index];
        const cardB = deck[b.index];
        if (!cardA || !cardB) {
          flipped = [];
          return;
        }

        if (cardA.file === cardB.file) {
          cardA.matched = true;
          cardB.matched = true;
          matchesFound += 1;
          a.btn.classList.add('matched');
          b.btn.classList.add('matched');
          flipped = [];

          if (matchesFound === deck.length / 2) {
            statusEl.textContent = `Great job! You found all ${matchesFound} pairs.`;
          } else {
            statusEl.textContent = `Good! ${matchesFound} pair${matchesFound === 1 ? '' : 's'} found. Keep going!`;
          }
        } else {
          busy = true;
          statusEl.textContent = 'Not a match, try again.';
          setTimeout(() => {
            a.btn.classList.remove('is-flipped');
            b.btn.classList.remove('is-flipped');
            a.btn.setAttribute('aria-label', 'Hidden card');
            b.btn.setAttribute('aria-label', 'Hidden card');
            flipped = [];
            busy = false;
            if (matchesFound === 0) {
              statusEl.textContent = 'Flip two cards to find a pair.';
            } else {
              statusEl.textContent = `You have ${matchesFound} pair${matchesFound === 1 ? '' : 's'} so far.`;
            }
          }, 900);
        }
      }

      function startGame() {
        if (!files.length) return;
        const pairCount = Number(pairRange.value) || 8;
        deck = buildDeck(pairCount);
        flipped = [];
        matchesFound = 0;
        busy = false;
        renderBoard();
        statusEl.textContent = 'Flip two cards to find a pair.';
        startBtn.textContent = 'Restart game';
      }

      startBtn.addEventListener('click', startGame);

      function handleKeydown(e) {
        const key = e.code || e.key;
        const isSpace = key === 'Space' || e.key === ' ' || e.key === 'Spacebar';
        if (isSpace) {
          if (!currentWordEl.textContent) return;
          e.preventDefault();
          speak(currentWordEl.textContent);
        }
      }

      window.addEventListener('keydown', handleKeydown);

      async function loadFiles() {
        try {
          const res = await fetch(basePath + 'manifest.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('No manifest');
          const arr = await res.json();
          if (!Array.isArray(arr) || !arr.length) throw new Error('Empty manifest');
          return arr;
        } catch {
          return DEFAULT_FILES.slice();
        }
      }

      (async () => {
        files = await loadFiles();
        updatePairLabel();
      })();
    </script>
  </body>
</html>

